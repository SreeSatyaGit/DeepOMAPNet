<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .mermaid { text-align: center; }
    </style>
</head>
<body>
    <h1>Multi-Task GAT-Transformer Model Architecture</h1>
    <div class="mermaid">
graph TB
    %% Input Layer
    subgraph "INPUT DATA"
        RNA["RNA Features<br/>36,601 genes × N cells"]
        ADT["ADT Features<br/>279 markers × N cells"]
        EDGE_RNA["RNA Graph Edges<br/>2 × E_rna"]
        EDGE_ADT["ADT Graph Edges<br/>2 × E_adt"]
        DEGREES["Node Degrees<br/>N × 2"]
        CLUSTERING["Clustering Coeffs<br/>N × 2"]
    end

    %% RNA Encoder Branch
    subgraph "RNA ENCODER BRANCH"
        RNA_DROP1["Dropout<br/>p=0.6"]
        GAT_RNA1["GAT Layer 1<br/>36,601 → 512<br/>8 heads"]
        ELU1["ELU<br/>Activation"]
        RNA_DROP2["Dropout<br/>p=0.6"]
        GAT_RNA2["GAT Layer 2<br/>512 → 64<br/>1 head"]
        ELU2["ELU<br/>Activation"]
        BN_RNA["BatchNorm1d<br/>64 channels"]
        RNA_EMB["RNA Embeddings<br/>N × 64"]
    end

    %% ADT Initialization Branch
    subgraph "ADT INITIALIZATION"
        GAT_ADT_INIT["GAT ADT Init<br/>64 → 64<br/>1 head"]
        ELU3["ELU<br/>Activation"]
        BN_ADT["BatchNorm1d<br/>64 channels"]
        ADT_INIT["Initial ADT<br/>N × 64"]
    end

    %% Transformer Fusion Module
    subgraph "TRANSFORMER FUSION MODULE"
        subgraph "LAYER 1"
            PROJ_RNA1["RNA Projection<br/>64 → 64"]
            PROJ_ADT1["ADT Projection<br/>64 → 64"]
            TRANS_RNA1["Graph Transformer<br/>RNA Branch"]
            TRANS_ADT1["Graph Transformer<br/>ADT Branch"]
            ADAPTER1["Adapter Layer<br/>L2 Regularization"]
            CROSS_ATT1["Cross-Attention<br/>RNA ↔ ADT"]
            POS_ENC1["Positional Encoding<br/>Graph Structure"]
        end
        
        subgraph "LAYER 2"
            PROJ_RNA2["RNA Projection<br/>64 → 64"]
            PROJ_ADT2["ADT Projection<br/>64 → 64"]
            TRANS_RNA2["Graph Transformer<br/>RNA Branch"]
            TRANS_ADT2["Graph Transformer<br/>ADT Branch"]
            ADAPTER2["Adapter Layer<br/>L2 Regularization"]
            CROSS_ATT2["Cross-Attention<br/>RNA ↔ ADT"]
            POS_ENC2["Positional Encoding<br/>Graph Structure"]
        end
        
        subgraph "LAYER 3"
            PROJ_RNA3["RNA Projection<br/>64 → 64"]
            PROJ_ADT3["ADT Projection<br/>64 → 64"]
            TRANS_RNA3["Graph Transformer<br/>RNA Branch"]
            TRANS_ADT3["Graph Transformer<br/>ADT Branch"]
            ADAPTER3["Adapter Layer<br/>L2 Regularization"]
            CROSS_ATT3["Cross-Attention<br/>RNA ↔ ADT"]
            POS_ENC3["Positional Encoding<br/>Graph Structure"]
        end
        
        FINAL_FUSION["Final Fusion<br/>Concat + Linear<br/>128 → 64"]
        FUSED_EMB["Fused Embeddings<br/>N × 64"]
    end

    %% Output Branches
    subgraph "MULTI-TASK OUTPUT HEADS"
        subgraph "ADT PREDICTION BRANCH"
            GAT_ADT_FINAL["GAT ADT Final<br/>64 → 64<br/>1 head"]
            FINAL_PROJ["Final Projection<br/>Linear + LayerNorm<br/>+ GELU + Dropout<br/>64 → 64 → 279"]
            ADT_PRED["ADT Predictions<br/>N × 279 markers"]
        end
        
        subgraph "AML CLASSIFICATION BRANCH"
            CLASS_HEAD["Classification Head<br/>Linear + LayerNorm<br/>+ GELU + Dropout<br/>64 → 32 → 1"]
            AML_PRED["AML Predictions<br/>N × 1 logits"]
        end
    end

    %% Loss Functions
    subgraph "MULTI-TASK LOSS"
        MSE_LOSS["MSE Loss<br/>ADT Regression"]
        BCE_LOSS["BCE Loss<br/>AML Classification"]
        REG_LOSS["L2 Regularization<br/>Adapters"]
        TOTAL_LOSS["Total Loss<br/>α×MSE + β×BCE + γ×L2"]
    end

    %% Attention Weights (Optional)
    subgraph "ATTENTION EXTRACTION"
        ATT_WEIGHTS["Attention Weights<br/>GAT + Transformer<br/>Cross-modal Interactions"]
    end

    %% Connections
    RNA --> RNA_DROP1
    RNA_DROP1 --> GAT_RNA1
    GAT_RNA1 --> ELU1
    ELU1 --> RNA_DROP2
    RNA_DROP2 --> GAT_RNA2
    GAT_RNA2 --> ELU2
    ELU2 --> BN_RNA
    BN_RNA --> RNA_EMB

    RNA_EMB --> GAT_ADT_INIT
    GAT_ADT_INIT --> ELU3
    ELU3 --> BN_ADT
    BN_ADT --> ADT_INIT

    RNA_EMB --> PROJ_RNA1
    ADT_INIT --> PROJ_ADT1
    PROJ_RNA1 --> TRANS_RNA1
    PROJ_ADT1 --> TRANS_ADT1
    TRANS_RNA1 --> ADAPTER1
    TRANS_ADT1 --> ADAPTER1
    ADAPTER1 --> CROSS_ATT1
    CROSS_ATT1 --> POS_ENC1

    POS_ENC1 --> PROJ_RNA2
    POS_ENC1 --> PROJ_ADT2
    PROJ_RNA2 --> TRANS_RNA2
    PROJ_ADT2 --> TRANS_ADT2
    TRANS_RNA2 --> ADAPTER2
    TRANS_ADT2 --> ADAPTER2
    ADAPTER2 --> CROSS_ATT2
    CROSS_ATT2 --> POS_ENC2

    POS_ENC2 --> PROJ_RNA3
    POS_ENC2 --> PROJ_ADT3
    PROJ_RNA3 --> TRANS_RNA3
    PROJ_ADT3 --> TRANS_ADT3
    TRANS_RNA3 --> ADAPTER3
    TRANS_ADT3 --> ADAPTER3
    ADAPTER3 --> CROSS_ATT3
    CROSS_ATT3 --> POS_ENC3

    POS_ENC3 --> FINAL_FUSION
    FINAL_FUSION --> FUSED_EMB

    FUSED_EMB --> GAT_ADT_FINAL
    FUSED_EMB --> CLASS_HEAD
    GAT_ADT_FINAL --> FINAL_PROJ
    FINAL_PROJ --> ADT_PRED
    CLASS_HEAD --> AML_PRED

    ADT_PRED --> MSE_LOSS
    AML_PRED --> BCE_LOSS
    ADAPTER1 --> REG_LOSS
    ADAPTER2 --> REG_LOSS
    ADAPTER3 --> REG_LOSS
    MSE_LOSS --> TOTAL_LOSS
    BCE_LOSS --> TOTAL_LOSS
    REG_LOSS --> TOTAL_LOSS

    %% Graph structure inputs
    EDGE_RNA -.-> GAT_RNA1
    EDGE_RNA -.-> GAT_RNA2
    EDGE_ADT -.-> GAT_ADT_INIT
    EDGE_ADT -.-> GAT_ADT_FINAL
    DEGREES -.-> POS_ENC1
    DEGREES -.-> POS_ENC2
    DEGREES -.-> POS_ENC3
    CLUSTERING -.-> POS_ENC1
    CLUSTERING -.-> POS_ENC2
    CLUSTERING -.-> POS_ENC3

    %% Attention weights (dashed)
    GAT_RNA1 -.-> ATT_WEIGHTS
    GAT_RNA2 -.-> ATT_WEIGHTS
    GAT_ADT_INIT -.-> ATT_WEIGHTS
    CROSS_ATT1 -.-> ATT_WEIGHTS
    CROSS_ATT2 -.-> ATT_WEIGHTS
    CROSS_ATT3 -.-> ATT_WEIGHTS

    %% Enhanced Styling for Better Visibility
    classDef inputNode fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#000000,font-weight:bold
    classDef rnaNode fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px,color:#000000,font-weight:bold
    classDef adtNode fill:#fff3e0,stroke:#f57c00,stroke-width:3px,color:#000000,font-weight:bold
    classDef fusionNode fill:#e8f5e8,stroke:#388e3c,stroke-width:3px,color:#000000,font-weight:bold
    classDef outputNode fill:#ffebee,stroke:#d32f2f,stroke-width:3px,color:#000000,font-weight:bold
    classDef lossNode fill:#fce4ec,stroke:#c2185b,stroke-width:3px,color:#000000,font-weight:bold
    classDef attentionNode fill:#f1f8e9,stroke:#689f38,stroke-width:3px,color:#000000,font-weight:bold

    class RNA,ADT,EDGE_RNA,EDGE_ADT,DEGREES,CLUSTERING inputNode
    class RNA_DROP1,GAT_RNA1,ELU1,RNA_DROP2,GAT_RNA2,ELU2,BN_RNA,RNA_EMB rnaNode
    class GAT_ADT_INIT,ELU3,BN_ADT,ADT_INIT adtNode
    class PROJ_RNA1,PROJ_ADT1,TRANS_RNA1,TRANS_ADT1,ADAPTER1,CROSS_ATT1,POS_ENC1,PROJ_RNA2,PROJ_ADT2,TRANS_RNA2,TRANS_ADT2,ADAPTER2,CROSS_ATT2,POS_ENC2,PROJ_RNA3,PROJ_ADT3,TRANS_RNA3,TRANS_ADT3,ADAPTER3,CROSS_ATT3,POS_ENC3,FINAL_FUSION,FUSED_EMB fusionNode
    class GAT_ADT_FINAL,FINAL_PROJ,ADT_PRED,CLASS_HEAD,AML_PRED outputNode
    class MSE_LOSS,BCE_LOSS,REG_LOSS,TOTAL_LOSS lossNode
    class ATT_WEIGHTS attentionNode

    </div>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
</body>
</html>